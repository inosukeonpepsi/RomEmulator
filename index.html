<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Doug's NES Emulator</title>
<style>
:root{--bg:#0f1724;--card:#0b1220;--accent:#ff0066;--muted:#94a3b8}
html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
body{background:linear-gradient(180deg,#071026 0%,#071020 60%);color:#e6eef8;padding:24px;box-sizing:border-box}
.layout{display:flex;gap:20px;align-items:flex-start}
.left{flex:3}
.right{flex:2;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border-radius:12px;padding:16px;max-height:90vh;overflow-y:auto}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
input[type=file]{background:rgba(255,255,255,0.02);border-radius:8px;padding:8px;color:inherit}
button{background:rgba(255,255,255,0.03);border:none;padding:8px 12px;border-radius:8px;color:inherit;cursor:pointer}
.big-btn{padding:10px 14px;font-weight:600}
.drop-zone{margin-top:12px;padding:18px;border-radius:10px;border:2px dashed rgba(255,255,255,0.06);color:var(--muted);text-align:center;user-select:none}
.drop-zone.dragover{background:rgba(255,255,255,0.02);border-color:var(--accent);color:#fff}
canvas{width:100%;display:block;background:black;border-radius:8px}
.muted{color:var(--muted)}
pre#log{height:260px;overflow:auto;background:#071026;padding:10px;border-radius:8px;color:var(--muted)}
.state-list{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.state-chip{background:#0b1220;padding:8px 10px;border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
</style>
</head>
<body>
<div class="layout">
  <div class="left">
    <div class="card">
      <h1>Doug's NES Emulator</h1>
      <p class="muted">Drag & drop a <strong>.nes</strong> ROM here or use the file input below.</p>
      <input id="romInput" type="file" accept=".nes">
      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button id="startBtn" class="big-btn">Start NES</button>
        <button id="fsBtn">Fullscreen</button>
        <button id="saveStateBtn">Save State</button>
        <button id="loadStateBtn">Load State</button>
      </div>
      <div id="dropZone" class="drop-zone">Drop your .nes ROM here</div>
      <div style="margin-top:12px">
        <span class="muted">Status:</span> <span id="status">idle</span>
      </div>
      <div id="game" style="margin-top:12px;width:100%;max-width:640px;height:480px"></div>
    </div>
  </div>

  <div class="right">
    <div class="card">
      <h2>Save States</h2>
      <p class="muted">States are saved to localStorage.</p>
      <div class="state-list" id="stateList"></div>
      <hr style="margin:12px 0; border-color: rgba(255,255,255,0.03)">
      <h3>Console</h3>
      <pre id="log">Logs will appear here.</pre>
    </div>
  </div>
</div>

<script>
let logEl = document.getElementById('log');
let statusEl = document.getElementById('status');
function log(...args){ logEl.textContent += '\n' + args.join(' '); logEl.scrollTop = logEl.scrollHeight; console.log(...args);}
function setStatus(s){statusEl.textContent = s;}

let nesROM = null;
const romInput = document.getElementById('romInput');
romInput.onchange = e => { nesROM = e.target.files[0]; setStatus('ROM selected: '+nesROM.name); }

const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', e => { dropZone.classList.remove('dragover'); });
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if(file && file.name.endsWith('.nes')){ nesROM = file; setStatus('ROM selected: '+nesROM.name); log('Dropped ROM:', file.name); }
  else { log('Ignored non-nes file:', file.name); }
});

// Fullscreen
document.getElementById('fsBtn').addEventListener('click', ()=>{
  const el = document.getElementById('game');
  if(!document.fullscreenElement) el.requestFullscreen().catch(e=>log('Fullscreen error',e));
  else document.exitFullscreen();
});

// Save/Load states
function listSlots(){ return Object.keys(localStorage).filter(k=>k.startsWith('nes_state_')).sort().reverse(); }
function refreshStateList(){
  const c = document.getElementById('stateList'); c.innerHTML = '';
  listSlots().forEach(k=>{
    const chip = document.createElement('div');
    chip.className='state-chip';
    chip.textContent = k.replace('nes_state_','');
    chip.onclick=()=>{ loadState(k); };
    c.appendChild(chip);
  });
}

// EmulatorJS NES integration
let EJS_NES_Instance = null;
async function startNES(){
  if(!nesROM){ alert('Please select a ROM first'); return; }
  setStatus('loading ROM...');
  const romURL = URL.createObjectURL(nesROM);

  // Setup EmulatorJS variables
  window.EJS_player = '#game';
  window.EJS_core = 'nes';
  window.EJS_gameUrl = romURL;
  window.EJS_biosUrl = '';
  window.EJS_pathtodata = 'https://raw.githubusercontent.com/EmulatorJS/EmulatorJS/master/data/';

  // Load the loader.js from official repo
  const loaderScript = document.createElement('script');
  loaderScript.src = 'https://raw.githubusercontent.com/EmulatorJS/EmulatorJS/master/data/loader.js';
  loaderScript.onload = ()=>{
    if(window.EJS_NES){
      EJS_NES_Instance = window.EJS_NES;
      setStatus('running');
      log('NES started:', nesROM.name);
    } else {
      log('Error: EJS_NES not defined');
      setStatus('error');
    }
  };
  document.body.appendChild(loaderScript);
}

// Save/Load states using EmulatorJS saveState/loadState
function saveState(){
  if(!EJS_NES_Instance){ alert('Start NES first'); return; }
  const bytes = EJS_NES_Instance.saveState();
  const name = 'slot_'+Date.now();
  localStorage.setItem('nes_state_'+name, JSON.stringify(Array.from(bytes)));
  refreshStateList();
  alert('State saved: '+name);
}
function loadState(slot){
  if(!EJS_NES_Instance){ alert('Start NES first'); return; }
  const raw = localStorage.getItem(slot);
  if(!raw){ alert('No state: '+slot); return; }
  const bytes = new Uint8Array(JSON.parse(raw));
  EJS_NES_Instance.loadState(bytes);
  alert('State loaded: '+slot.replace('nes_state_',''));
}

document.getElementById('startBtn').addEventListener('click', startNES);
document.getElementById('saveStateBtn').addEventListener('click', saveState);
document.getElementById('loadStateBtn').addEventListener('click', ()=>{
  const slots = listSlots();
  if(slots.length===0){ alert('No states'); return; }
  loadState(slots[0]);
});
refreshStateList();
</script>
</body>
</html>
