<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Doug's NES Emulator</title>
<style>
  :root{--bg:#0f1724;--card:#0b1220;--accent:#ff0066;--muted:#94a3b8}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:linear-gradient(180deg,#071026 0%, #071020 60%);color:#e6eef8;padding:24px;box-sizing:border-box}
  .layout{display:flex;gap:20px;align-items:flex-start}
  .left{flex:3}
  .right{flex:2;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border-radius:12px;padding:16px;max-height:90vh;overflow-y:auto}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
  input[type=file]{background:rgba(255,255,255,0.02); border-radius:8px; padding:8px; color:inherit}
  button{background:rgba(255,255,255,0.03); border:none; padding:8px 12px; border-radius:8px; color:inherit; cursor:pointer}
  .big-btn{padding:10px 14px;font-weight:600}
  .drop-zone{margin-top:12px;padding:18px;border-radius:10px;border:2px dashed rgba(255,255,255,0.06);color:var(--muted);text-align:center;user-select:none}
  .drop-zone.dragover{background:rgba(255,255,255,0.02);border-color:var(--accent);color:#fff}
  canvas{width:100%;display:block;background:black;border-radius:8px;margin-top:12px}
  .muted{color:var(--muted)}
  pre#log{height:260px;overflow:auto;background:#071026;padding:10px;border-radius:8px;color:var(--muted)}
  .state-list{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
  .state-chip{background:#0b1220;padding:8px 10px;border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
</style>
</head>
<body>
<div class="layout">
  <div class="left">
    <div class="card">
      <h1>Doug's NES Emulator</h1>
      <p class="muted">Upload a NES ROM (.nes) using the file input or drag & drop below.</p>

      <input id="romInput" type="file" accept=".nes" />

      <div id="dropZone" class="drop-zone">
        Drag & drop your <strong>.nes</strong> file here.
      </div>

      <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
        <button id="startBtn" class="big-btn">Start Emulator</button>
        <button id="fsBtn">Fullscreen</button>
        <button id="saveStateBtn">Save State</button>
        <button id="loadStateBtn">Load State</button>
      </div>

      <canvas id="screen" width="256" height="240"></canvas>

      <div style="margin-top:12px"><span class="muted">Status:</span> <span id="status">idle</span></div>
    </div>
  </div>

  <div class="right">
    <div class="card">
      <h2>Save States</h2>
      <div class="state-list" id="stateList"></div>
      <hr style="margin:12px 0; border-color: rgba(255,255,255,0.03)">
      <h3>Console</h3>
      <pre id="log">Logs will appear here.</pre>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/emulatorjs/dist/nes.min.js"></script>
<script>
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
function log(...args){ logEl.textContent += '\n' + args.join(' '); logEl.scrollTop = logEl.scrollHeight; console.log(...args);}
function setStatus(s){statusEl.textContent = s;}

let romFile = null;
const romInput = document.getElementById('romInput');
const dropZone = document.getElementById('dropZone');

romInput.onchange = e => { romFile = e.target.files[0]; log('Selected ROM:', romFile.name); }

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', e => { dropZone.classList.remove('dragover'); });
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('dragover');
  const files = Array.from(e.dataTransfer.files);
  for(const f of files){ if(f.name.endsWith('.nes')){ romFile=f; log('Dropped ROM:', f.name); break; } }
});

let nes = null;
let canvas = document.getElementById('screen');

function startEmulator(){
  if(!romFile){ alert('No ROM selected'); return; }
  setStatus('Loading ROM...');
  const reader = new FileReader();
  reader.onload = function(e){
    const romData = new Uint8Array(e.target.result);
    try{
      if(nes) nes.stop();
      nes = new EmulatorJS.NES({canvas: canvas});
      nes.loadROM(romData);
      nes.start();
      setStatus('Running');
      log('Emulator started with ROM:', romFile.name);
    }catch(err){ log('Error starting NES:', err); setStatus('error'); }
  };
  reader.readAsArrayBuffer(romFile);
}

document.getElementById('startBtn').addEventListener('click', startEmulator);
document.getElementById('fsBtn').addEventListener('click', ()=>{
  if(!document.fullscreenElement) canvas.requestFullscreen().catch(e=>log('Fullscreen error',e));
  else document.exitFullscreen();
});

/* Save/load states using localStorage */
function listStates(){ return Object.keys(localStorage).filter(k=>k.startsWith('nes_state_')).sort().reverse(); }
function refreshStateList(){
  const c = document.getElementById('stateList'); c.innerHTML='';
  listStates().forEach(k=>{
    const name = k.replace('nes_state_','');
    const chip = document.createElement('div');
    chip.className='state-chip';
    chip.textContent=name;
    chip.onclick=()=>loadState(name);
    c.appendChild(chip);
  });
}
function saveState(){
  if(!nes){ alert('Start emulator first'); return; }
  const state = nes.saveState();
  const key = 'nes_state_' + (new Date()).toISOString();
  localStorage.setItem(key, JSON.stringify(Array.from(state)));
  refreshStateList();
  alert('Saved state: '+key);
}
function loadState(name){
  if(!nes){ alert('Start emulator first'); return; }
  const raw = localStorage.getItem('nes_state_'+name);
  if(!raw){ alert('No such state'); return; }
  const state = new Uint8Array(JSON.parse(raw));
  nes.loadState(state);
  alert('Loaded state: '+name);
}

document.getElementById('saveStateBtn').addEventListener('click', saveState);
document.getElementById('loadStateBtn').addEventListener('click', ()=>{ 
  const keys = listStates(); if(!keys.length) return alert('No saved states'); 
  loadState(keys[0].replace('nes_state_','')); 
});

refreshStateList();
</script>
</body>
</html>
