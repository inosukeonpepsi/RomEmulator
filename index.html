<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>NDS Emulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    background: #0f172a;
    color: #fff;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
  }
  #screen {
    width: 512px;
    height: 768px;
    background: #000;
    margin: 20px auto;
    display: block;
  }
  #dropZone {
    width: 400px;
    margin: 20px auto;
    padding: 25px;
    border: 2px dashed #3b82f6;
    border-radius: 12px;
    color: #94a3b8;
  }
  #dropZone.drag {
    background: rgba(59,130,246,0.2);
  }
  input[type=file] {
    margin-top: 15px;
  }
  #log {
    margin-top: 20px;
    font-size: 14px;
    color: #94a3b8;
    white-space: pre-line;
  }
</style>
</head>
<body>

<h1>Nintendo DS Emulator (melonDS WASM)</h1>

<canvas id="screen" width="512" height="768"></canvas>

<div id="dropZone">
  <b>Drop your .nds file here</b><br><br>
  or <br><br>
  <input type="file" id="fileInput" accept=".nds">
</div>

<div id="log">Loading emulator...</div>

<script>
// ------------------------------
// Simple log helper
// ------------------------------
function log(msg) {
  document.getElementById("log").textContent += "\n" + msg;
}

// ------------------------------
// GitHub RAW paths for BIOS
// ------------------------------
const BIOS_PATHS = {
  "bios7.bin": "https://raw.githubusercontent.com/inosukeonpepsi/RomEmulator/main/bios7.bin",
  "bios9.bin": "https://raw.githubusercontent.com/inosukeonpepsi/RomEmulator/main/bios9.bin",
  "firmware.bin": "https://raw.githubusercontent.com/inosukeonpepsi/RomEmulator/main/firmware.bin"
};

// ------------------------------
// Load BIOS from GitHub
// ------------------------------
async function fetchBIOS(name) {
  let url = BIOS_PATHS[name];
  log("Fetching " + name + "...");
  let resp = await fetch(url);
  if (!resp.ok) throw new Error("Failed: " + name);
  let arr = new Uint8Array(await resp.arrayBuffer());
  log(name + " loaded (" + arr.length + " bytes)");
  return arr;
}

// ------------------------------
// Load melonDS WASM core
// ------------------------------
log("Loading melonDS core...");
let script = document.createElement("script");
script.src = "https://cdn.jsdelivr.net/gh/44670/melonDS-wasm@master/wasm-port/a.out.js";
document.body.appendChild(script);

let melonModule = null;

script.onload = async () => {
  log("melonDS core loaded, initializing...");
  melonModule = await createMelonDS({
    canvas: document.getElementById("screen"),
  });

  // load BIOS into FS
  try {
    melonModule.FS.writeFile("bios7.bin", await fetchBIOS("bios7.bin"));
    melonModule.FS.writeFile("bios9.bin", await fetchBIOS("bios9.bin"));
    melonModule.FS.writeFile("firmware.bin", await fetchBIOS("firmware.bin"));
    log("All BIOS files installed.");
  } catch (e) {
    log("Error loading BIOS: " + e);
  }

  log("Ready. Drop a ROM.");
};

// ------------------------------
// Drag & Drop ROM Loader
// ------------------------------
let dropZone = document.getElementById("dropZone");

dropZone.addEventListener("dragover", e => {
  e.preventDefault();
  dropZone.classList.add("drag");
});

dropZone.addEventListener("dragleave", e => {
  dropZone.classList.remove("drag");
});

dropZone.addEventListener("drop", async e => {
  e.preventDefault();
  dropZone.classList.remove("drag");

  let file = e.dataTransfer.files[0];
  if (file) loadROM(file);
});

// File picker
document.getElementById("fileInput").addEventListener("change", async e => {
  let file = e.target.files[0];
  if (file) loadROM(file);
});

// ------------------------------
// Load ROM into the Emulator
// ------------------------------
async function loadROM(file) {
  log("Loading ROM: " + file.name);

  let arr = new Uint8Array(await file.arrayBuffer());
  melonModule.FS.writeFile("game.nds", arr);

  log("ROM loaded (" + arr.length + " bytes). Booting...");
  melonModule._runNDS("game.nds");
}

</script>
</body>
</html>
